# 文档引用API文档

## API概述

本文档描述了文档引用系统的所有API接口，用于管理项目级和会话级的知识库文档引用关系。

## 基础概念

- **项目级引用**：项目引用的文档会对该项目下的所有会话生效
- **会话级引用**：仅对特定会话生效，且不能与项目级引用的文档重复
- **知识库文档**：category_id=5 的plan_documents记录

## API接口列表

### 1. 查询会话引用的文档

**GET** `/v1/chat/conversations/{conversation_id}/referenced-documents`

查询指定会话引用的所有文档，包含项目级和会话级引用。

**路径参数：**
- `conversation_id` (string): 会话ID

**响应示例：**
```json
{
  "conversation_id": "12345",
  "project_references": [
    {
      "id": 1,
      "project_id": 1,
      "conversation_id": null,
      "document_id": 100,
      "reference_type": "project",
      "document_filename": "API设计规范.md",
      "document_content": "API设计规范内容...",
      "document_version": 1,
      "document_created_time": "2024-01-01T10:00:00"
    }
  ],
  "conversation_references": [
    {
      "id": 2,
      "project_id": 1,
      "conversation_id": "12345",
      "document_id": 101,
      "reference_type": "conversation",
      "document_filename": "特殊需求.md",
      "document_content": "特殊需求内容...",
      "document_version": 1,
      "document_created_time": "2024-01-01T11:00:00"
    }
  ]
}
```

### 2. 获取可引用的知识库文档列表

**GET** `/v1/plan/documents/history?project_id={project_id}&category_id=5`

获取指定项目下的所有知识库文档，用于前端选择引用。

**查询参数：**
- `project_id` (int): 项目ID
- `category_id` (int): 固定为5（知识库分类）

**响应示例：**
```json
[
  {
    "id": 100,
    "project_id": 1,
    "category_id": 5,
    "filename": "API设计规范.md",
    "content": "API设计规范的详细内容...",
    "version": 1,
    "source": "user",
    "related_log_id": null,
    "created_time": "2024-01-01T10:00:00"
  }
]
```

### 3. 管理项目级引用

#### 3.1 查询项目级引用

**GET** `/v1/projects/{project_id}/document-references`

**路径参数：**
- `project_id` (int): 项目ID

#### 3.2 设置项目级引用

**POST** `/v1/projects/{project_id}/document-references`

完全替换项目的文档引用关系。

**请求体：**
```json
{
  "document_ids": [100, 101, 102]
}
```

**响应示例：**
```json
{
  "message": "Project document references updated successfully",
  "added_count": 2,
  "removed_count": 1,
  "current_references": [100, 101, 102]
}
```

#### 3.3 清空项目级引用

**DELETE** `/v1/projects/{project_id}/document-references`

### 4. 管理会话级引用

#### 4.1 查询会话级引用

**GET** `/v1/chat/conversations/{conversation_id}/document-references`

**路径参数：**
- `conversation_id` (string): 会话ID

#### 4.2 设置会话级引用

**POST** `/v1/chat/conversations/{conversation_id}/document-references`

完全替换会话的文档引用关系。

**请求体：**
```json
{
  "document_ids": [103, 104]
}
```

**注意事项：**
- 会话只能引用其所属项目的文档
- 不能引用项目级已引用的文档（避免重复）

**错误响应示例：**
```json
{
  "detail": "Documents already referenced at project level: [100, 101]"
}
```

#### 4.3 清空会话级引用

**DELETE** `/v1/chat/conversations/{conversation_id}/document-references`

### 5. 文档详情管理

#### 5.1 查看文档详情

**GET** `/v1/plan/documents/{document_id}`

**路径参数：**
- `document_id` (int): 文档ID

#### 5.2 编辑文档内容

**PUT** `/v1/plan/documents/{document_id}`

更新文档内容，会创建新版本而非覆盖原版本。

**请求体：**
```json
{
  "filename": "新文件名.md",
  "content": "更新后的内容",
  "source": "user"
}
```

**注意：** 所有字段都是可选的，只更新提供的字段。

## 前端实现流程

### 1. 会话页面显示引用文档

```javascript
// 获取会话引用的文档
const response = await fetch(`/v1/chat/conversations/${conversationId}/referenced-documents`);
const data = await response.json();

// 显示项目级引用
displayProjectReferences(data.project_references);

// 显示会话级引用  
displayConversationReferences(data.conversation_references);
```

### 2. 编辑项目级引用

```javascript
// 1. 获取可选择的知识库文档
const availableDocs = await fetch(`/v1/plan/documents/history?project_id=${projectId}&category_id=5`);

// 2. 获取当前项目引用
const currentRefs = await fetch(`/v1/projects/${projectId}/document-references`);

// 3. 显示多选界面，预选当前引用的文档

// 4. 保存更新
const updateData = { document_ids: selectedDocIds };
await fetch(`/v1/projects/${projectId}/document-references`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(updateData)
});
```

### 3. 编辑会话级引用

```javascript
// 1. 获取可选择的知识库文档（排除项目级已引用的）
const availableDocs = await fetch(`/v1/plan/documents/history?project_id=${projectId}&category_id=5`);
const projectRefs = await fetch(`/v1/projects/${projectId}/document-references`);
const projectRefIds = projectRefs.map(ref => ref.document_id);
const selectableDocs = availableDocs.filter(doc => !projectRefIds.includes(doc.id));

// 2. 获取当前会话引用
const currentRefs = await fetch(`/v1/chat/conversations/${conversationId}/document-references`);

// 3. 显示多选界面

// 4. 保存更新
const updateData = { document_ids: selectedDocIds };
await fetch(`/v1/chat/conversations/${conversationId}/document-references`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(updateData)
});
```

### 4. 查看/编辑文档内容

```javascript
// 查看文档详情
const doc = await fetch(`/v1/plan/documents/${documentId}`);

// 编辑文档
const updateData = {
  filename: "新文件名.md",
  content: "更新的内容"
};
await fetch(`/v1/plan/documents/${documentId}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(updateData)
});
```

## 错误处理

所有API都遵循标准HTTP状态码：
- `200`: 成功
- `400`: 请求参数错误
- `404`: 资源不存在
- `500`: 服务器内部错误

错误响应格式：
```json
{
  "detail": "错误描述信息"
}
```